<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - ASCEND</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CSS -->
    <!-- CSS -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/pages.css">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/include-components.js"></script>
    <style>
        /* Custom Dashboard Header Styles */
        .header {
            justify-content: flex-end;
            position: fixed;
            /* Ensure context */
        }

        .dashboard-nav-group {
            display: flex;
            align-items: center;
            gap: 15px;
            /* Decreased padding between buttons */
            position: absolute;
            left: 45%;
            transform: translateX(-50%);
        }

        /* Ensure nav items inside the group behave correctly */
        .dashboard-nav-group .sidebar-nav-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent !important;
            /* Override global sidebar active styles */
            border: none !important;
            margin: 0 !important;
        }

        .dashboard-nav-group .sidebar-nav-item:hover {
            color: var(--text-primary);
            transform: translateY(-2px);
            /* Hover animation */
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dashboard-nav-group .sidebar-nav-item:active {
            transform: scale(0.95);
            /* Click animation */
        }

        .dashboard-nav-group .sidebar-nav-item.active {
            color: var(--primary);
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <div class="sidebar-logo-icon">
                <i data-lucide="zap" style="width: 25px; height: 25px; fill: #4DA3FF; color: #4DA3FF;"></i>
            </div>
            <div class="sidebar-logo-text">ASCEND</div>
        </div>

        <nav class="sidebar-nav">

            <a href="ask-question.html" class="sidebar-nav-item">
                <i data-lucide="message-circle" style="width: 20px; height: 20px; stroke-width: 1.5;"></i>
                <span>Ask Questions</span>
            </a>
            <a href="My-Mentor.html" class="sidebar-nav-item">
                <i data-lucide="user-check" style="width: 20px; height: 20px; stroke-width: 1.5;"></i>

                <span>My Mentors</span>
            </a>
            <a href="career-exploration.html" class="sidebar-nav-item">
                <i data-lucide="compass" style="width: 20px; height: 20px; stroke-width: 1.5;"></i>
                <span>RoadMaps</span>
            </a>
            <a href="mentees.html" class="sidebar-nav-item">
                <i data-lucide="graduation-cap" style="width: 20px; height: 20px; stroke-width: 1.5;"></i>
                <span>Mentors</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="sidebar-nav-item" id="collapseBtn">
                <i data-lucide="chevron-left" style="width: 20px; height: 20px; stroke-width: 1.5;"></i>
                <span>Collapse</span>
            </div>

            <a href="login.html" class="sidebar-nav-item" id="logoutBtn">
                <i data-lucide="log-out" style="width: 20px; height: 20px; stroke-width: 1.5;"></i>
                <span>Sign Out</span>
            </a>
        </div>
    </aside>

    <!-- Header -->
    <header class="header">
        <div class="dashboard-nav-group">
            <a href="dashboard.html" class="sidebar-nav-item">
                <i data-lucide="layout-dashboard" style="width: 18px; height: 18px; stroke-width: 2;"></i>
                <span>Dashboard</span>
            </a>
            <a href="contact.html" class="sidebar-nav-item ">
                <i data-lucide="mail" style="width: 18px; height: 18px; stroke-width: 2;"></i>
                <span>Contact Us</span>
            </a>
            <a href="about.html" class="sidebar-nav-item ">
                <i data-lucide="info" style="width: 18px; height: 18px; stroke-width: 2;"></i>
                <span>About Us</span>
            </a>
        </div>

        <div class="header-user" onclick="window.location.href='profile.html'" style="cursor: pointer;">
            <div class="header-user-info">
                <div class="header-user-name">Loading...</div>
                <div class="header-user-role">Student</div>
            </div>
            <div class="avatar avatar-md"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-layout">
        <div class="page-container">
            <div class="main-content">
                <div class="page-header">
                    <div class="page-header-content">
                        <h1 class="page-title">Edit Profile</h1>
                        <p class="page-subtitle">Manage your personal information and career interests.</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                    <!-- Edit Form -->
                    <div class="card">
                        <div class="card-body">
                            <form id="profileForm">
                                <h3 style="margin-bottom: 20px; font-size: 18px; font-weight: 600;">Basic Information
                                </h3>

                                <div class="input-group">
                                    <label class="input-label">Full Name</label>
                                    <input type="text" class="input" id="fullName" placeholder="Your Name">
                                </div>

                                <div class="input-group">
                                    <label class="input-label">University / College</label>
                                    <input type="text" class="input" id="university"
                                        placeholder="e.g. Stanford University">
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Major / Degree</label>
                                    <input type="text" class="input" id="degree"
                                        placeholder="e.g. Computer Science (B.S.)">
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Graduation Year</label>
                                    <input type="number" class="input" id="gradYear" placeholder="e.g. 2025">
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Bio & Interests</label>
                                    <textarea class="input" id="bio" rows="4"
                                        placeholder="Tell us about yourself..."></textarea>
                                </div>

                                <h3 style="margin: 24px 0 20px 0; font-size: 18px; font-weight: 600;">Start-up / Career
                                    Interests
                                </h3>
                                <div class="input-group">
                                    <label class="input-label">Current Goal</label>
                                    <input type="text" class="input" id="currentGoalInput"
                                        placeholder="e.g., Senior Software Engineer at a FAANG Company">
                                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 6px;">This will
                                        be displayed on your dashboard.</p>
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Skills (Comma separated)</label>
                                    <input type="text" class="input" id="skillsInput"
                                        placeholder="Python, Java, React, Docker, AWS">
                                    <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;"
                                        id="skillsBadges">
                                        <!-- badges will be added dynamically -->
                                    </div>
                                </div>



                                <div style="margin-top: 32px; display: flex; justify-content: flex-end;">
                                    <button type="submit" class="btn btn-primary"
                                        onclick="alert('Profile updated successfully!')">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Profile Preview -->
                    <div>
                        <h3
                            style="margin-bottom: 16px; font-size: 14px; color: var(--text-secondary); text-transform: uppercase;">
                            Public Preview</h3>
                        <div class="card">
                            <div class="card-body" style="text-align: center;">
                                <div class="avatar avatar-lg" id="previewAvatar"
                                    style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 16px auto;">?
                                </div>
                                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 4px;" id="previewName">Your
                                    Name</h3>
                                <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 4px;"
                                    id="previewRole">Student
                                </div>
                                <div style="color: var(--primary); font-size: 14px; font-weight: 500; margin-bottom: 16px;"
                                    id="previewUni">
                                    University</div>

                                <div
                                    style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 20px;">
                                    <span class="badge badge-secondary">Student</span>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Footer -->
            <div id="footer-placeholder" data-src="dashboard-footer.html"></div>
        </div>

    </main>

    <script src="js/navigation.js"></script>
    <script src="js/auth-guard.js"></script>
    <script>
        lucide.createIcons();

        // Load existing profile data
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Use authFetch or manually add header
                const token = localStorage.getItem('auth_token');
                const response = await fetch('http://127.0.0.1:5000/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    // Populate basic info (some from user model, some from profile)
                    // Note: In a real app, we'd want input fields for all these or read-only display
                    // For now, let's assume the form has these IDs or we need to add them.
                    // The current HTML has hardcoded values in inputs without IDs. I will add IDs below.

                    if (data.username) {
                        document.getElementById('previewName').textContent = data.username;
                        // Default initials from username
                        document.getElementById('previewAvatar').textContent = data.username.substring(0, 2).toUpperCase();
                    }
                    if (data.role) {
                        document.getElementById('previewRole').textContent = data.role.charAt(0).toUpperCase() + data.role.slice(1);
                    }

                    if (data.profile) {
                        if (document.getElementById('university')) document.getElementById('university').value = data.profile.university || '';
                        if (document.getElementById('bio')) document.getElementById('bio').value = data.profile.bio || '';
                        if (document.getElementById('currentGoalInput')) document.getElementById('currentGoalInput').value = data.profile.current_goal || '';
                        if (document.getElementById('gradYear')) document.getElementById('gradYear').value = data.profile.graduation_year || '';
                        if (document.getElementById('fullName')) document.getElementById('fullName').value = data.profile.full_name || '';
                        if (document.getElementById('degree')) document.getElementById('degree').value = data.profile.degree || '';

                        // Update Preview
                        if (data.profile.full_name) {
                            document.getElementById('previewName').textContent = data.profile.full_name;

                            // Calculate initials from full name
                            const names = data.profile.full_name.trim().split(' ');
                            let initials = '';
                            if (names.length >= 2) {
                                initials = (names[0][0] + names[names.length - 1][0]).toUpperCase();
                            } else if (names.length === 1) {
                                initials = names[0].substring(0, 2).toUpperCase();
                            }
                            if (initials) {
                                document.getElementById('previewAvatar').textContent = initials;
                            }

                            // Update Header User Profile (Sync with dashboard.html behavior)
                            const headerName = document.querySelector('.header-user-name');
                            if (headerName) headerName.textContent = data.profile.full_name || data.username;

                            const headerAvatar = document.querySelector('.header-user .avatar');
                            if (headerAvatar && (data.profile.full_name || data.username)) {
                                const nameToUse = data.profile.full_name || data.username;
                                const parts = nameToUse.trim().split(' ');
                                let headInitials = parts[0][0];
                                if (parts.length > 1) {
                                    headInitials += parts[parts.length - 1][0];
                                }
                                headerAvatar.textContent = headInitials.toUpperCase();
                            }
                        }
                        if (data.profile.university) {
                            document.getElementById('previewUni').textContent = data.profile.university;
                            if (data.profile.graduation_year) {
                                document.getElementById('previewUni').textContent += " '" + window.String(data.profile.graduation_year).slice(-2);
                            }
                        }
                    }

                    if (data.skills && data.skills.length > 0) {
                        const skillsInput = document.getElementById('skillsInput');
                        if (skillsInput) skillsInput.value = data.skills.join(', ');

                        const badgesContainer = document.getElementById('skillsBadges');
                        if (badgesContainer) {
                            badgesContainer.innerHTML = ''; // Clear existing
                            data.skills.forEach(skill => {
                                const badge = document.createElement('span');
                                badge.className = 'badge';
                                badge.textContent = skill;
                                badgesContainer.appendChild(badge);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching profile:', error);
            }

            // Check if we should focus on the goal field (kept from original for UX)
            if (window.location.hash === '#goal') {
                const goalInput = document.getElementById('currentGoalInput');
                if (goalInput) {
                    setTimeout(() => {
                        goalInput.focus();
                        goalInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        goalInput.style.borderColor = 'var(--primary)';
                    }, 100);
                }
            }
        });

        document.getElementById('profileForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const university = document.getElementById('university').value;
            const bio = document.getElementById('bio').value;
            const currentGoal = document.getElementById('currentGoalInput').value;
            const gradYear = document.getElementById('gradYear').value;
            const fullName = document.getElementById('fullName').value;
            const degree = document.getElementById('degree').value;
            // Get skills from input - assuming user edits the comma separated string
            const skillsInput = document.getElementById('skillsInput');
            const skills = skillsInput ? skillsInput.value : '';

            const token = localStorage.getItem('auth_token');

            try {
                const response = await fetch('http://127.0.0.1:5000/api/user/profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        university: university,
                        bio: bio,
                        current_goal: currentGoal,
                        graduation_year: gradYear,
                        full_name: fullName,
                        degree: degree,
                        skills: skills
                    })
                });

                if (response.ok) {
                    localStorage.setItem('ascend_current_goal', currentGoal); // Keep for legacy frontend logic
                    alert('Profile saved successfully! Redirecting to dashboard...');
                    window.location.href = 'dashboard.html';
                } else {
                    const errorData = await response.json();
                    alert(`Failed to save profile: ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('An error occurred: ' + error.message);
            }
        });
    </script>
</body>

</html>